<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>⚡ Intercom Dashboard Bot</title>
  <style>
    :root{
      --bg:#071018; --line:#143245; --text:#d7f7ff; --muted:#8ab3c2;
      --accent:#4ff7c8; --accent2:#4aa3ff; --warn:#ffce4a; --bad:#ff5b6b;
      --shadow: 0 12px 30px rgba(0,0,0,.35); --radius: 18px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 20% 10%, rgba(79,247,200,.10), transparent 45%),
                  radial-gradient(900px 800px at 90% 20%, rgba(74,163,255,.10), transparent 40%),
                  var(--bg);
      color:var(--text);
      font-family: var(--mono);
      letter-spacing:.2px;
    }
    .wrap{max-width:980px;margin:18px auto;padding:16px}
    .title{font-size:28px;font-weight:900;display:flex;gap:10px;align-items:center;margin:6px 0 14px}
    .title .bolt{color:var(--warn)}
    .sub{color:var(--muted);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(20,50,69,.7);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      position:relative; overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute;inset:-2px;
      background: radial-gradient(600px 180px at 30% 0%, rgba(79,247,200,.12), transparent 60%),
                  radial-gradient(600px 180px at 80% 0%, rgba(74,163,255,.10), transparent 60%);
      pointer-events:none; opacity:.9;
    }
    .card > *{position:relative}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:10px 12px;border:1px solid rgba(20,50,69,.85);
      border-radius:999px;background:rgba(7,21,31,.6); color:var(--text);
    }
    .pill strong{color:var(--accent)}
    .btn{
      cursor:pointer; padding:10px 14px;border-radius:12px;
      border:1px solid rgba(20,50,69,.9); background:rgba(7,21,31,.65);
      color:var(--text); font-family:var(--mono);
    }
    .btn:hover{border-color:rgba(79,247,200,.55)}
    .mini{color:var(--muted);font-size:12px}
    .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    input, select{
      width:100%; padding:12px 12px;border-radius:14px;
      border:1px solid rgba(20,50,69,.85); background:rgba(7,21,31,.72);
      color:var(--text); font-family:var(--mono); outline:none;
    }
    input:focus, select:focus{border-color:rgba(79,247,200,.6)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .two{grid-template-columns:1fr} }
    .hr{height:1px;background:rgba(20,50,69,.8);margin:12px 0}
    pre{
      margin:0; padding:12px; border-radius:14px;
      border:1px solid rgba(20,50,69,.85); background:rgba(7,21,31,.75);
      color:var(--text); overflow:auto; line-height:1.35;
      white-space:pre-wrap;
    }
    canvas{
      width:100%;
      height:220px;
      border-radius:14px;
      border:1px solid rgba(20,50,69,.85);
      background:rgba(7,21,31,.65);
    }
    code{color:var(--accent2)}
    .ok{color:var(--accent)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .accent2{color:var(--accent2)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title"><span class="bolt">⚡</span> Intercom Dashboard Bot <span class="mini">(localhost)</span></div>
    <div class="sub">
      Chart: CoinGecko 24h market_chart → rendered on Canvas. (No libs, super light)
    </div>

    <div class="grid">

      <!-- WALLET -->
      <div class="card">
        <div class="row">
          <div class="pill">SOL Balance: <strong id="solBal">—</strong> SOL</div>
          <div class="row" style="justify-content:flex-end">
            <div class="pill mini">Updated: <span id="updated">—</span></div>
            <button class="btn" id="refreshBtn">Refresh</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="label">Wallet (Solana Public Key)</div>
        <input id="pubkey" placeholder="Paste your Solana address (public key)..." />
        <div class="mini" style="margin-top:8px">
          TX list uses cached calls to reduce rate limits.
        </div>
      </div>

      <!-- PRICES + CHART -->
      <div class="card">
        <div class="row">
          <div class="pill">Prices (USD): <span id="pricesLine">—</span></div>
          <div class="row">
            <select id="coinSel" title="Chart asset">
              <option value="bitcoin">BTC</option>
              <option value="ethereum">ETH</option>
              <option value="solana">SOL</option>
            </select>
            <button class="btn" id="chartBtn">Load Chart</button>
          </div>
        </div>
        <div class="hr"></div>
        <canvas id="chart"></canvas>
        <div class="mini" style="margin-top:8px">
          Tip: switch asset → Load Chart.
        </div>
      </div>

      <!-- AGENT + DEXSCREENER -->
      <div class="card">
        <div class="row">
          <div class="pill">Agent Mode (Dexscreener)</div>
          <div class="pill mini">Mode: <span id="agentMode">—</span></div>
        </div>
        <div class="hr"></div>

        <div class="label">Token (symbol or CA)</div>
        <input id="tokenQ" placeholder="e.g. BONK or 0x... (CA recommended)" />

        <div style="height:10px"></div>

        <div class="two">
          <button class="btn" id="dexBtn">Check Dex</button>
          <button class="btn" id="analyzeBtn">Run Agent</button>
        </div>

        <div style="height:12px"></div>

        <div class="label">Market Snapshot</div>
        <pre id="dexBox">{ "ok": true, "note": "Click 'Check Dex' to fetch live market data." }</pre>

        <div style="height:12px"></div>

        <div class="label">Agent Output</div>
        <pre id="agentBox">{ "ok": true, "note": "Click 'Run Agent' to generate signal + risk + decision." }</pre>
      </div>

      <!-- TX -->
      <div class="card">
        <div class="pill">Recent TX</div>
        <div class="hr"></div>
        <pre id="txBox">{ "ok": true, "note": "Enter a wallet address then refresh." }</pre>
      </div>

      <!-- SIMULATOR -->
      <div class="card">
        <div class="pill">Swap Simulator (x*y=k)</div>
        <div class="hr"></div>

        <div class="two">
          <div>
            <div class="label">Reserve X</div>
            <input id="rx" value="1000" inputmode="decimal" />
          </div>
          <div>
            <div class="label">Reserve Y</div>
            <input id="ry" value="1000" inputmode="decimal" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="two">
          <div>
            <div class="label">Amount In (X)</div>
            <input id="ain" value="10" inputmode="decimal" />
          </div>
          <div>
            <div class="label">Fee (bps)</div>
            <input id="fee" value="30" inputmode="numeric" />
          </div>
        </div>

        <div style="height:12px"></div>

        <button class="btn" id="simBtn">Simulate</button>
        <div style="height:12px"></div>
        <pre id="simBox">{ "ok": true, "note": "Simulate to see output." }</pre>
      </div>

    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const state = { timer: null, refreshing: false, intervalMs: 20000 };

    function nowLocal() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    async function getJSON(url) {
      const r = await fetch(url);
      return await r.json();
    }

    function setPretty(el, obj) {
      el.textContent = JSON.stringify(obj, null, 2);
    }

    function fmtPrice(n) {
      if (typeof n !== "number") return "—";
      return n >= 1000 ? n.toFixed(0) : n >= 1 ? n.toFixed(2) : n.toFixed(6);
    }

    function fmtPct(n) {
      if (typeof n !== "number") return "—";
      const sign = n >= 0 ? "+" : "";
      return `${sign}${n.toFixed(2)}%`;
    }

    // ---- Canvas chart (simple line) ----
    function drawLineChart(canvas, points, label) {
      const ctx = canvas.getContext("2d");

      // crisp on mobile
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      const w = rect.width;
      const h = rect.height;

      // background grid
      ctx.clearRect(0, 0, w, h);
      ctx.globalAlpha = 1;

      ctx.strokeStyle = "rgba(20,50,69,.65)";
      ctx.lineWidth = 1;

      for (let i = 1; i <= 5; i++) {
        const y = (h * i) / 6;
        ctx.beginPath();
        ctx.moveTo(12, y);
        ctx.lineTo(w - 12, y);
        ctx.stroke();
      }

      if (!points || points.length < 2) {
        ctx.fillStyle = "rgba(215,247,255,.8)";
        ctx.font = "12px ui-monospace, Menlo, monospace";
        ctx.fillText("No chart data.", 16, 22);
        return;
      }

      const vals = points.map(p => p[1]);
      const min = Math.min(...vals);
      const max = Math.max(...vals);
      const pad = (max - min) * 0.05 || 1;

      const x0 = 12, y0 = 18, x1 = w - 12, y1 = h - 18;
      const scaleX = (x1 - x0) / (points.length - 1);
      const scaleY = (y1 - y0) / (max - min + pad * 2);

      // line
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(79,247,200,.95)";
      ctx.beginPath();
      for (let i = 0; i < points.length; i++) {
        const x = x0 + i * scaleX;
        const y = y1 - (points[i][1] - (min - pad)) * scaleY;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // label + min/max
      ctx.fillStyle = "rgba(215,247,255,.9)";
      ctx.font = "12px ui-monospace, Menlo, monospace";
      const last = points[points.length - 1][1];
      ctx.fillText(`${label}  24h`, 16, 18);
      ctx.fillText(`last: $${fmtPrice(last)}`, 16, h - 10);
      ctx.fillText(`min: $${fmtPrice(min)}  max: $${fmtPrice(max)}`, w - 250, h - 10);
    }

    async function loadChart() {
      const coin = $("coinSel").value;
      const c = await getJSON(`/api/chart?coin=${encodeURIComponent(coin)}`);
      if (!c.ok) {
        drawLineChart($("chart"), [], "Chart");
        return;
      }
      const label = coin === "bitcoin" ? "BTC" : coin === "ethereum" ? "ETH" : "SOL";
      drawLineChart($("chart"), c.prices, label);
    }

    async function refreshAll() {
      if (state.refreshing) return;
      state.refreshing = true;

      $("updated").textContent = nowLocal();

      const pubkey = $("pubkey").value.trim();
      localStorage.setItem("intercom_pubkey", pubkey);

      // Prices line
      try {
        const p = await getJSON("/api/prices");
        if (!p.ok) throw new Error(p.error || "prices error");
        const btc = p.data.bitcoin;
        const eth = p.data.ethereum;
        const sol = p.data.solana;

        $("pricesLine").innerHTML =
          `<span class="accent2">BTC</span> $${fmtPrice(btc.usd)} (${fmtPct(btc.usd_24h_change)}) | ` +
          `<span class="accent2">ETH</span> $${fmtPrice(eth.usd)} (${fmtPct(eth.usd_24h_change)}) | ` +
          `<span class="accent2">SOL</span> $${fmtPrice(sol.usd)} (${fmtPct(sol.usd_24h_change)})`;
      } catch (e) {
        $("pricesLine").innerHTML = `<span class="bad">error</span>: ${String(e.message || e)}`;
      }

      // Balance + TX
      if (pubkey) {
        try {
          const b = await getJSON(`/api/sol/balance?pubkey=${encodeURIComponent(pubkey)}`);
          $("solBal").textContent = b.ok && typeof b.sol === "number" ? b.sol.toFixed(4) : "—";
        } catch { $("solBal").textContent = "—"; }

        try {
          const t = await getJSON(`/api/sol/tx?pubkey=${encodeURIComponent(pubkey)}`);
          setPretty($("txBox"), t);
        } catch (e) {
          setPretty($("txBox"), { ok:false, error: String(e.message || e) });
        }
      } else {
        $("solBal").textContent = "—";
        setPretty($("txBox"), { ok:true, note:"Enter a wallet address then refresh." });
      }

      state.refreshing = false;
    }

    async function simulate() {
      try {
        const payload = {
          reserveX: Number($("rx").value),
          reserveY: Number($("ry").value),
          amountIn: Number($("ain").value),
          feeBps: Number($("fee").value)
        };
        const r = await fetch("/api/simulate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        setPretty($("simBox"), j);
      } catch (e) {
        setPretty($("simBox"), { ok:false, error: String(e.message || e) });
      }
    }

    async function checkDex() {
      const q = $("tokenQ").value.trim();
      if (!q) return setPretty($("dexBox"), { ok:false, error:"Enter token symbol or CA" });

      const j = await getJSON(`/api/dex?q=${encodeURIComponent(q)}`);
      setPretty($("dexBox"), j);
    }

    async function runAgent() {
      const q = $("tokenQ").value.trim();
      if (!q) return setPretty($("agentBox"), { ok:false, error:"Enter token symbol or CA" });

      const j = await getJSON(`/api/agent/analyze?q=${encodeURIComponent(q)}`);
      $("agentMode").textContent = j?.mode || "—";
      setPretty($("agentBox"), j);
    }

    // Init
    const saved = localStorage.getItem("intercom_pubkey");
    if (saved) $("pubkey").value = saved;

    $("refreshBtn").addEventListener("click", refreshAll);
    $("simBtn").addEventListener("click", simulate);
    $("dexBtn").addEventListener("click", checkDex);
    $("analyzeBtn").addEventListener("click", runAgent);

    $("chartBtn").addEventListener("click", loadChart);
    $("coinSel").addEventListener("change", loadChart);

    refreshAll();
    loadChart();
    state.timer = setInterval(refreshAll, state.intervalMs);
    window.addEventListener("resize", () => loadChart());
  </script>
</body>
</html>
